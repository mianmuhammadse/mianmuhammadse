name: Cache Stremio Card

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  cache:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Fetch Stremio SVG
        run: |
          curl --fail --max-time 60 -s "https://stremio.mianmuhammad.dev/api/view?uid=mianmuhammad&source=stremio&cover_image=true&theme=natemoo-re&show_offline=true&background_color=121212&interchange=false&bar_color=8a5dc0&show_recents=true&recents_limit=3&bar_color_cover=false" -o stremio-card.svg

      - name: Validate SVG
        run: |
          if [ ! -s stremio-card.svg ]; then
            echo "ERROR: SVG file is empty"
            exit 1
          fi
          if ! grep -q "<svg" stremio-card.svg; then
            echo "ERROR: File is not a valid SVG"
            exit 1
          fi
          echo "SUCCESS: SVG is valid"

      - name: Commit and Push Cached SVG
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git stash
          git pull origin main --rebase
          git stash pop
          git add stremio-card.svg
          git diff --cached --quiet || git commit -m "chore: update cached stremio card"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
